#select ce.subject_id,
#       pt.sex, pt.dob, pt.dod, pt.hospital_expire_flg, ce.itemid, 
#       ci.description, charttime, realtime, 
#       value1num,value1uom, value2num,value2uom
#from chartevents ce,
#     d_chartitems ci, 
#     d_patients pt
#where hospital_expire_flg='Y' and pt.sex='M'
#  and ce.subject_id in (
#
### 12, 21, 31, 61, 67, 101, 106, 112, 164, 175, 320, 356, 405, 408, 413, 414, 466, 490, 491, 499, 530, 561, 590, 592, 618, 634, 705, 743, 771, 804, 819, 826, 834, 843, 884, 905, 906, 914, 937, 950, 984, 1000, 1006, 1039, 1049, 1052, 1060, 1092, 1094, 1113, 1114, 1120, 1165, 1193, 1234, 1242, 1264, 1284, 1389, 1399, 1436, 1470, 1472, 1534, 1537, 1571, 1574, 1588, 1594, 1599, 1676, 1678, 1704, 1782, 1785, 1787, 1790, 1811, 1832, 1855, 1863, 1882, 1892, 1901, 1919, 1924, 1944, 1967, 1972, 1979, 1982, 1984, 1987, 1997, 2014, 2015, 2025, 2053, 2057, 2061, 2121, 2148, 2172, 2180, 2207, 2222, 2225, 2270, 2286, 2415, 2428, 2452, 2456, 2478, 2482, 2486, 2511, 2539, 2553, 2570, 2592, 2638, 2647, 2683, 2690, 2714, 2775, 2800, 2836, 2882, 2904, 2912, 2944, 2990, 3013, 3015, 3133, 3181, 3184, 3201, 3213, 3302, 3320, 3340, 3361, 3369, 3437, 3474, 3523, 3526, 3563, 3577, 3588, 3619, 3649, 3702, 3705, 3764, 3780, 3804, 3841, 3852, 3881, 3893, 3896, 3921, 3932, 3988, 4007, 4034, 4070, 4074, 4082, 4107, 4120, 4139, 4142, 4145, 4152, 4312, 4331, 4351, 4362, 4399, 4465, 4516, 4521, 4544, 4587, 4594, 4607, 4622, 4666, 4700, 4754, 4760, 4778, 4791, 4794, 4796, 4798, 4803, 4816, 4828, 4833, 4839, 4875, 4884, 4894, 4902, 4914, 4925, 5033, 5034, 5054, 5056, 5072, 5097, 5102, 5174, 5205, 5232, 5251, 5252, 5282, 5289, 5304, 5313, 5369, 5370, 5391, 5443, 5452, 5494, 5504, 5506, 5554, 5557, 5562, 5596, 5598, 5666, 5670, 5690, 5713, 5738, 5749, 5768, 5786, 5812, 5818, 5844, 5850, 5872, 5874, 5886, 5890, 5909, 5910, 5937, 5966, 5993, 6010, 6016, 6018, 6020, 6042, 6093, 6098, 6112, 6128, 6129, 6153, 6191, 6206, 6215, 6252, 6292, 6334, 6399, 6492, 6496, 6525, 6539, 6566, 6568, 6610, 6637, 6654, 6676, 6718, 6735, 6790, 6809, 6822, 6855, 6861, 6865, 6873, 6908, 6914, 6933, 6938, 7018, 7045, 7073, 7132, 7209, 7234, 7237, 7277, 7282, 7452, 7475, 7532, 7539, 7552, 7600, 7605, 7621, 7637, 7659, 7668, 7683, 7686, 7701, 7752, 7785, 7847, 7894, 7910, 7999, 8043, 8061, 8066, 8099, 8100, 8128, 8141, 8147, 8156, 8163, 8173, 8196, 8206, 8210, 8264, 8311, 8314, 8332, 8362, 8364, 8369, 8444, 8451, 8466, 8481, 8565, 8569, 8623, 8637, 8645, 8658, 8685, 8718, 8721, 8749, 8829, 8842, 8892, 8898, 8907, 8915, 8940, 8952, 8974, 8992, 9013, 9040, 9054, 9077, 9090, 9105, 9136, 9137, 9139, 9141, 9172, 9200, 9202, 9266, 9289, 9296, 9300, 9302, 9331, 9377, 9388, 9412, 9426, 9465, 9478, 9482, 9490, 9594, 9611, 9648, 9722, 9768, 9787, 9800, 9839, 9883, 9885, 9896, 9905, 9908, 9936, 9999, 10019, 10059, 10089, 10094, 10101, 10102, 10159, 10160, 10185, 10200, 10254, 10258, 10274, 10288, 10306, 10314, 10326, 10327, 10330, 10356, 10366, 10391, 10408, 10417, 10424, 10446, 10451, 10453, 10465, 10482, 10510, 10518, 10545, 10552, 10557, 10558, 10568, 10579, 10629, 10664, 10679, 10692, 10731, 10739, 10768, 10810, 10881, 10925, 10942, 10950, 10987, 10990, 11004, 11017, 11067, 11070, 11091, 11100, 11101, 11106, 11108, 11155, 11167, 11194, 11209, 11228, 11304, 11307, 11334, 11395, 11519, 11577, 11589, 11592, 11614, 11617, 
##
#11623, 11634, 11659, 11687, 11720, 11724, 11764, 11801, 11819, 11825, 11858, 11879, 11923, 11949, 11979, 12058, 12070, 12081, 12089, 12091, 12109, 12161, 12184, 12212, 12226, 12278, 12310, 12330, 12343, 12391, 12403, 12407, 12412, 12413, 12469, 12487, 12531, 12532, 12533, 12537, 12581, 12607, 12650, 12677, 12686, 12713, 12715, 12735, 12739, 12752, 12767, 12796, 12819, 12844, 12849, 12876, 12905, 12916, 13098, 13151, 13183, 13207, 13301, 13302, 13309, 13325, 13338, 13367, 13396, 13430, 13451, 13538, 13566, 13584, 13600, 13603, 13632, 13684, 13695, 13705, 13715, 13735, 13757, 13781, 13789, 13790, 13793, 13796, 13843, 13859, 13890, 13891, 13924, 13934, 13943, 13956, 13968, 14012, 14038, 14058, 14116, 14126, 14191, 14219, 14244, 14249, 14254, 14263, 14265, 14266, 14276, 14302, 14346, 14358, 14398, 14472, 14474, 14485, 14486, 14497, 14514, 14539, 14548, 14575, 14579, 14585, 14590, 14624, 14629, 14659, 14676, 14692, 14695, 14705, 14709, 14716, 14723, 14772, 14784, 14802, 14818, 14887, 14905, 14922, 14936, 14938, 14947, 14982, 15048, 15118, 15124, 15156, 15170, 15185, 15193, 15250, 15277, 15303, 15305, 15314, 15353, 15365, 15378, 15421, 15450, 15452, 15461, 15544, 15545, 15546, 15566, 15573, 15629, 15631, 15646, 15647, 15648, 15747, 15761, 15773, 15794, 15811, 15902, 15932, 15963, 15964, 15972, 15974, 15991, 15996, 15997, 16026, 16066, 16129, 16141, 16145, 16149, 16159, 16172, 16173, 16216, 16311, 16338, 16351, 16362, 16421, 16426, 16447, 16485, 16511, 16523, 16565, 16617, 16618, 16641, 16653, 16679, 16691, 16721, 16805, 16830, 16855, 16874, 16881, 16915, 16917, 16918, 16937, 16949, 16963, 16990, 17006, 17075, 17083, 17104, 17108, 17123, 17136, 17145, 17182, 17224, 17236, 17259, 17302, 17354, 17358, 17372, 17393, 17431, 17461, 17485, 17538, 17546, 17560, 17574, 17586, 17599, 17604, 17657, 17660, 17668,
#
##  17680, 17682, 17683, 
##  17688, 17722, 17750
#
#) 
#  and ce.itemid in (455,763,3581,1148,211,618,646)
#  and ce.itemid=ci.itemid 
#  and pt.subject_id=ce.subject_id
#
#select ce.subject_id, 
#       pt.sex, pt.dob, pt.dod, pt.hospital_expire_flg, ce.itemid, 
#       ci.description, charttime, realtime, 
#       value1num,value1uom, value2num,value2uom
#from chartevents ce,
#     d_chartitems ci, 
#     d_patients pt
#where hospital_expire_flg='Y' and pt.sex='F'
#  and ce.subject_id not in (1381)
#  and ce.itemid in (763,455,1148,618,115,211,3581,646)
#  and ce.itemid=ci.itemid 
#  and pt.subject_id=ce.subject_id
#
#1. ok get that in files for 
#
#WHAT IS OUTPUT? >> push data to csv format and load into R
#
#> alert vs time
#> summary graph
#>
#
#
#2. get 1000 rows returned
#have to list all the patients except last one, rerun
#mv from ~/Downloads/export... ~/project/data/expired/
#output list of patients to not include total



from subprocess import call
import os,csv


# exportqueryresults.csv   --> project/data/expired/male  --> project/data/expired/female
try:
	cmd_mv = 'find /home/solver/Downloads/ -type f -name 'exportqueryresult*' -exec mv {} --target-directory=/home/solver/project/data/expired/male/' +  nofiles+1 +'.csv \;'
	
	call(cmd_mv, shell=True)

except:
	print "copy dwnld file error"

# cwd -> #files
cwd = os.getcwd()
files=next(os.walk(cwd))[2] #relative path
css = [ c for c in files if('.csv' in c) ]
if ! len(css): 
	nofiles=0
else:
	nofiles = len(css)

# have 1000 rows, if new patient, append, return that array -1 (ie hell come up in next search)
pts=[]
for i,cs in enumerate(css):
	pts.append([])
	with open( cs, 'rb') as csvfile:
		rd = csv.reader(csvfile)

		for j,row in enumerate(rd):
#			print 'j ', j, row[1]
			if j == 0:
				pts[i].append( row[1] )
			elif j>0 and row[1] != pts[i][-1] :
				pts[-1].append(row[1])
		#print 'ids :', cs, pts[-1]
		pts[i]=pts[i][:-1]

print 'ids :', css
print " "
for pp in pts:
	for p in pp: 
		print p, ' ,'


#print out the patients with spo2
#with open('1k_male_spo2.csv', 'rb') as ff:
#	pp = csv.reader(ff)
#	jj = [row for j,row in enumerate(pp)]
#	
#print 'pp ', pp

'''
select ce.subject_id,
       pt.sex, pt.dob, pt.dod, pt.hospital_expire_flg, ce.itemid, 
       ci.description, charttime, realtime, 
       value1num,value1uom, value2num,value2uom
from chartevents ce,
     d_chartitems ci, 
     d_patients pt
where hospital_expire_flg='Y' and pt.sex='M'
  and ce.subject_id in (

 1832, 1855, 1863, 1882, 1892, 1901, 1919, 1924, 1944, 1967, 1972, 1979, 1982, 1984, 1987, 1997, 2014, 2015, 2025, 2053, 2057, 2061, 2121, 2148, 2172, 2180, 2207, 2222, 2225, 2270, 2286, 2415, 2428, 2452, 2456, 2478, 2482, 2486, 

) 
  and ce.itemid in (455,763,3581,1148,211,618,646)
  and ce.itemid=ci.itemid 
  and pt.subject_id=ce.subject_id

----
select ce.subject_id,
       pt.sex, pt.dob, pt.dod, pt.hospital_expire_flg, ce.itemid, 
       ci.description, charttime, realtime, 
       value1num,value1uom, value2num,value2uom
from chartevents ce,
     d_chartitems ci, 
     d_patients pt
where hospital_expire_flg='Y' and pt.sex='M'
  and ce.subject_id in (

12, 21, 31, 61, 67, 101, 106, 112, 164, 175, 320, 356, 405, 408, 413, 414, 466, 490, 491, 499, 530, 561, 590, 592, 618, 634, 705, 743, 771, 804, 819, 826, 834, 843, 884, 905, 906, 914, 937, 950, 984, 1000, 1006, 1039, 1049, 1052, 1060, 1092, 1094, 1113, 1114, 1120, 1165, 1193, 1234, 1242, 1264, 1284, 1389, 1399, 1436, 1470, 1472, 1534, 1537, 1571, 1574, 1588, 1594, 1599, 1676, 1678, 1704, 1782, 1785, 1787, 1790, 1811, 1832, 1855, 1863, 1882, 1892, 1901, 1919, 1924, 1944, 1967, 1972, 1979, 1982, 1984, 1987, 1997, 2014, 2015, 2025, 2053, 2057, 2061, 2121, 2148, 2172, 2180, 2207, 2222, 2225, 2270, 2286, 2415, 2428, 2452, 2456, 2478, 2482, 2486, 2511, 2539, 2553, 2570, 2592, 2638, 2647, 2683, 2690, 2714, 2775, 2800, 2836, 2882, 2904, 2912, 2944, 2990, 3013, 3015, 3133, 3181, 3184, 3201, 3213, 3302, 3320, 3340, 3361, 3369, 3437, 3474, 3523, 3526, 3563, 3577, 3588, 3619, 3649, 3702, 3705, 3764, 3780, 3804, 3841, 3852, 3881, 3893, 3896, 3921, 3932, 3988, 4007, 4034, 4070, 4074, 4082, 4107, 4120, 4139, 4142, 4145, 4152, 4312, 4331, 4351, 4362, 4399, 4465, 4516, 4521, 4544, 4587, 4594, 4607, 4622, 4666, 4700, 4754, 4760, 4778, 4791, 4794, 4796, 4798, 4803, 4816, 4828, 4833, 4839, 4875, 4884, 4894, 4902, 4914, 4925, 5033, 5034, 5054, 5056, 5072, 5097, 5102, 5174, 5205, 5232, 5251, 5252, 5282, 5289, 5304, 5313, 5369, 5370, 5391, 5443, 5452, 5494, 5504, 5506, 5554, 5557, 5562, 5596, 5598, 5666, 5670, 5690, 5713, 5738, 5749, 5768, 5786, 5812, 5818, 5844, 5850, 5872, 5874, 5886, 5890, 5909, 5910, 5937, 5966, 5993, 6010, 6016, 6018, 6020, 6042, 6093, 6098, 6112, 6128, 6129, 6153, 6191, 6206, 6215, 6252, 6292, 6334, 6399, 6492, 6496, 6525, 6539, 6566, 6568, 6610, 6637, 6654, 6676, 6718, 6735, 6790, 6809, 6822, 6855, 6861, 6865, 6873, 6908, 6914, 6933, 6938, 7018, 7045, 7073, 7132, 7209, 7234, 7237, 7277, 7282, 7452, 7475, 7532, 7539, 7552, 7600, 7605, 7621, 7637, 7659, 7668, 7683, 7686, 7701, 7752, 7785, 7847, 7894, 7910, 7999, 8043, 8061, 8066, 8099, 8100, 8128, 8141, 8147, 8156, 8163, 8173, 8196, 8206, 8210, 8264, 8311, 8314, 8332, 8362, 8364, 8369, 8444, 8451, 8466, 8481, 8565, 8569, 8623, 8637, 8645, 8658, 8685, 8718, 8721, 8749, 8829, 8842, 8892, 8898, 8907, 8915, 8940, 8952, 8974, 8992, 9013, 9040, 9054, 9077, 9090, 9105, 9136, 9137, 9139, 9141, 9172, 9200, 9202, 9266, 9289, 9296, 9300, 9302, 9331, 9377, 9388, 9412, 9426, 9465, 9478, 9482, 9490, 9594, 9611, 9648, 9722, 9768, 9787, 9800, 9839, 9883, 9885, 9896, 9905, 9908, 9936, 9999, 10019, 10059, 10089, 10094, 10101, 10102, 10159, 10160, 10185, 10200, 10254, 10258, 10274, 10288, 10306, 10314, 10326, 10327, 10330, 10356, 10366, 10391, 10408, 10417, 10424, 10446, 10451, 10453, 10465, 10482, 10510, 10518, 10545, 10552, 10557, 10558, 10568, 10579, 10629, 10664, 10679, 10692, 10731, 10739, 10768, 10810, 10881, 10925, 10942, 10950, 10987, 10990, 11004, 11017, 11067, 11070, 11091, 11100, 11101, 11106, 11108, 11155, 11167, 11194, 11209, 11228, 11304, 11307, 11334, 11395, 11519, 11577, 11589, 11592, 11614, 11617,
#
11623, 11634, 11659, 11687, 11720, 11724, 11764, 11801, 11819, 11825, 11858, 11879, 11923, 11949, 11979, 12058, 12070, 12081, 12089, 12091, 12109, 12161, 12184, 12212, 12226, 12278, 12310, 12330, 12343, 12391, 12403, 12407, 12412, 12413, 12469, 12487, 12531, 12532, 12533, 12537, 12581, 12607, 12650, 12677, 12686, 12713, 12715, 12735, 12739, 12752, 12767, 12796, 12819, 12844, 12849, 12876, 12905, 12916, 13098, 13151, 13183, 13207, 13301, 13302, 13309, 13325, 13338, 13367, 13396, 13430, 13451, 13538, 13566, 13584, 13600, 13603, 13632, 13684, 13695, 13705, 13715, 13735, 13757, 13781, 13789, 13790, 13793, 13796, 13843, 13859, 13890, 13891, 13924, 13934, 13943, 13956, 13968, 14012, 14038, 14058, 14116, 14126, 14191, 14219, 14244, 14249, 14254, 14263, 14265, 14266, 14276, 14302, 14346, 14358, 14398, 14472, 14474, 14485, 14486, 14497, 14514, 14539, 14548, 14575, 14579, 14585, 14590, 14624, 14629, 14659, 14676, 14692, 14695, 14705, 14709, 14716, 14723, 14772, 14784, 14802, 14818, 14887, 14905, 14922, 14936, 14938, 14947, 14982, 15048, 15118, 15124, 15156, 15170, 15185, 15193, 15250, 15277, 15303, 15305, 15314, 15353, 15365, 15378, 15421, 15450, 15452, 15461, 15544, 15545, 15546, 15566, 15573, 15629, 15631, 15646, 15647, 15648, 15747, 15761, 15773, 15794, 15811, 15902, 15932, 15963, 15964, 15972, 15974, 15991, 15996, 15997, 16026, 16066, 16129, 16141, 16145, 16149, 16159, 16172, 16173, 16216, 16311, 16338, 16351, 16362, 16421, 16426, 16447, 16485, 16511, 16523, 16565, 16617, 16618, 16641, 16653, 16679, 16691, 16721, 16805, 16830, 16855, 16874, 16881, 16915, 16917, 16918, 16937, 16949, 16963, 16990, 17006, 17075, 17083, 17104, 17108, 17123, 17136, 17145, 17182, 17224, 17236, 17259, 17302, 17354, 17358, 17372, 17393, 17431, 17461, 17485, 17538, 17546, 17560, 17574, 17586, 17599, 17604, 17657, 17660, 17668,

#  17680, 17682, 17683, 
#  17688, 17722, 17750

) 
  and ce.itemid in (455,763,3581,1148,211,618,646)
  and ce.itemid=ci.itemid 
  and pt.subject_id=ce.subject_id

